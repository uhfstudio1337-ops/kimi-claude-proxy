#!/bin/bash
# Claude Code Pro — подписка через Smart Proxy v3.3 (Linux)
# Прозрачный проброс на Anthropic API, без телеметрии

export ANTHROPIC_BASE_URL="http://localhost:8787"

# Находим cli.js (кешируем путь)
CLI_CACHE="$HOME/.local/bin/.cli_path_cache"
if [ -f "$CLI_CACHE" ] && [ -f "$(cat "$CLI_CACHE")" ]; then
    CLI_PATH="$(cat "$CLI_CACHE")"
else
    CLI_PATH="$(npm root -g 2>/dev/null)/@anthropic-ai/claude-code/cli.js"
    if [ -f "$CLI_PATH" ]; then
        echo "$CLI_PATH" > "$CLI_CACHE"
    fi
fi

if [ ! -f "$CLI_PATH" ]; then
    echo "[ОШИБКА] cli.js не найден: $CLI_PATH"
    echo "Установите: sudo npm install -g @anthropic-ai/claude-code"
    exit 1
fi

# ══════════════════════════════════════════════════════════
# Проверка патча
# ══════════════════════════════════════════════════════════
if ! grep -q "localhost:8787" "$CLI_PATH" 2>/dev/null; then
    echo "══════════════════════════════════════════════════════════"
    echo " [!] cli.js НЕ пропатчен — автопатч..."
    echo "══════════════════════════════════════════════════════════"
    sudo chmod u+w "$CLI_PATH" 2>/dev/null || chmod u+w "$CLI_PATH" 2>/dev/null || true
    node "$HOME/.local/bin/patch-claude-full.js" "$CLI_PATH"
    if [ $? -ne 0 ]; then
        echo "[ОШИБКА] Патч не удался!"
        exit 1
    fi
    sudo chmod a-w "$CLI_PATH" 2>/dev/null || chmod a-w "$CLI_PATH" 2>/dev/null || true
    echo "[OK] cli.js пропатчен и защищён"
    echo "══════════════════════════════════════════════════════════"
else
    echo "[OK] cli.js пропатчен"
fi

# ══════════════════════════════════════════════════════════
# Проверка прокси
# ══════════════════════════════════════════════════════════
if ! curl -s http://localhost:8787/health >/dev/null 2>&1; then
    echo "[!] Прокси не запущен! Запустить автоматически? [Y/n]"
    read -r answer
    if [ "$answer" != "n" ] && [ "$answer" != "N" ]; then
        nohup node "$HOME/.local/bin/kimi-proxy.js" > /tmp/kimi-proxy.log 2>&1 &
        sleep 1
        if curl -s http://localhost:8787/health >/dev/null 2>&1; then
            echo "[OK] Прокси запущен (PID: $!, лог: /tmp/kimi-proxy.log)"
        else
            echo "[ОШИБКА] Прокси не удалось запустить. Проверьте /tmp/kimi-proxy.log"
            exit 1
        fi
    else
        exit 1
    fi
fi

echo "[MODE] Anthropic Pro (transparent proxy, no telemetry)"
exec claude "$@"
